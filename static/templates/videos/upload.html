<h1>Upload your video</h1>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.js"></script>

<div id="video-dropzone" class="dropzone">
    <div class="dz-message">
        <strong>Drop video files here or click to upload</strong>
    </div>
</div>

<div id="upload-progress" style="display: none; margin-top: 20px;">
    <div style="display: flex; align-items: center; gap: 15px;">
        <img style="width:64px;height:64px;" src="/static/webp/evanspin.gif" alt="Loading...">
        <div style="flex: 1;">
            <p>Upload Progress:</p>
            <div id="progress-bar" style="width: 100%; background-color: #f0f0f0; border-radius: 4px;">
                <div id="progress-fill" style="width: 0%; height: 20px; background-color: #007bff; border-radius: 4px; transition: width 0.3s;"></div>
            </div>
            <div id="progress-text">0%</div>
        </div>
    </div>
</div>

<div id="upload-errors" style="display: none; margin-top: 20px;">
    <h3>Upload Errors</h3>
    <div id="error-list"></div>
</div>

<script>
Dropzone.autoDiscover = false;

// Track upload progress for multiple files
let activeUploads = new Map();

function updateProgressBar() {
    const uploads = Array.from(activeUploads.values());
    if (uploads.length === 0) {
        document.getElementById("upload-progress").style.display = "none";
        return;
    }
    
    document.getElementById("upload-progress").style.display = "block";
    
    // Calculate average progress
    const totalProgress = uploads.reduce((sum, progress) => sum + progress, 0);
    const averageProgress = totalProgress / uploads.length;
    
    document.getElementById("progress-fill").style.width = averageProgress + "%";
    document.getElementById("progress-text").textContent = `${Math.round(averageProgress)}% (${uploads.length} file${uploads.length > 1 ? 's' : ''})`;
}

const videoDropzone = new Dropzone("#video-dropzone", {
    url: "/api/v1/video",
    chunking: true,
    chunkSize: 128 * 1024 * 1024, // 128 Mib chunks
    retryChunks: true,
    retryChunksLimit: 3,
    parallelChunkUploads: false,
    acceptedFiles: "video/*",
    maxFiles: 5,
    addRemoveLinks: true,
    maxFilesize: 100 * 1024 * 1024 * 1024, // 100GiB

    init: function() {
        this.on("addedfile", function(file) {
            // Initialize progress tracking for this file
            activeUploads.set(file.upload.uuid, 0);
            updateProgressBar();
        });
        
        this.on("uploadprogress", function(file, progress) {
            // Update progress for this specific file
            activeUploads.set(file.upload.uuid, progress);
            updateProgressBar();
        });
        
        this.on("success", function(file, response) {
            console.log("Upload successful:", response);
            if (response.status === 'chunk_received') {
                // Chunk received, continue uploading
                return;
            } else {
                // Complete file uploaded
                activeUploads.delete(file.upload.uuid);
                updateProgressBar();
                
                // Handle success without redirect
                if (activeUploads.size === 0) {
                    this.removeAllFiles();
                }
            }
        });
        
        this.on("error", function(file, errorMessage) {
            try {
                console.log("foo!", errorMessage);
                message_json = JSON.parse(errorMessage);
                if (message_json.redirect_url) {
                    if (activeUploads.size === 0) {
                        // If this is the last file, redirect
                        console.log("me!");
                        window.location.href = message_json.redirect_url;
                    } else {
                        console.log("you!");
                        window.open(message_json.redirect_url, "_blank");
                    }
                    return;
                }
            } catch (error) { }
            console.error("Upload failed:", errorMessage);
            
            // Remove failed file from progress tracking
            activeUploads.delete(file.upload.uuid);
            updateProgressBar();
            
            // Display error in the error section
            const errorSection = document.getElementById("upload-errors");
            const errorList = document.getElementById("error-list");
            
            const errorDiv = document.createElement("div");
            errorDiv.className = "upload-error";
            
            const errorText = typeof errorMessage === 'string' ? errorMessage : (errorMessage.message || 'Unknown error occurred');
            errorDiv.innerHTML = `
                <strong>File:</strong> ${file.name}<br>
                <strong>Error:</strong> ${errorText}<br>
                <small>Time: ${new Date().toLocaleTimeString()}</small>
            `;
            
            errorList.appendChild(errorDiv);
            errorSection.style.display = "block";
        });
        
        this.on("removedfile", function(file) {
            // Remove file from progress tracking if manually removed
            activeUploads.delete(file.upload.uuid);
            updateProgressBar();
        });
        
        this.on("complete", function(file) {
            if (file.status === "success") {
                console.log("File upload completed successfully");
            }
        });
    }
});
</script>