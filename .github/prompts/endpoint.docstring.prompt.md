---
mode: edit
---
# Endpoint Docstring Rules and Guidelines

You are tasked with writing comprehensive docstrings for API endpoint functions. Follow these exact formatting rules and structure requirements.

## Required Docstring Structure

Every endpoint function MUST include a docstring with the following sections in this exact order:

### 1. Title Section
- Start with `###` followed by a descriptive title
- Use action-oriented language (e.g., "Log in with bot token", "Create a new role", "Upload a mission")
- Include endpoint type context when relevant (e.g., "Create a new role (Local only)")
- Keep titles concise but descriptive
- Use sentence case (capitalize only the first word and proper nouns)

### 2. AI Attribution Section
- ALWAYS include the line: `*Docstring generated by AI.*`
- This must appear immediately after the title section
- Use italics formatting as shown above
- This is mandatory for all endpoint docstrings

### 3. Description Section
- Provide a detailed explanation of what the endpoint does
- Include authentication/authorization requirements (session, roles, permissions)
- Mention any special restrictions (local-only, specific roles/permissions required)
- Include important behavior notes (e.g., automatic user injection, parameter sources)
- Use present tense and active voice

### 4. Args Section
- Use `**Args:**` as the section header
- Format: `- \`parameter_name\` (\`type\`): Description of the parameter.`
- Include ALL parameters except those automatically injected by decorators
- For path parameters, specify they are from the URL path
- For automatically injected parameters (like `session_user`), note the decorator responsible
- Use backticks around parameter names and types
- End descriptions with a period
- List parameters in logical order (path params first, then body params)

### 5. Returns Section
- Use `**Returns:**` as the section header
- Format: `- \`ReturnType\`:`
- Include detailed status codes and response formats
- Use sub-bullet points for different response scenarios
- Format: `- **Success (code)**: Description or response format`
- Format: `- **Error (code)**: Description and reason`
- Be specific about JSON response structure when applicable

### 6. Example Section
- Use `**Example:**` as the section header
- Show the HTTP method and endpoint URL
- Include request body format when applicable
- Show realistic parameter values
- Use proper JSON formatting for request bodies
- Include brief description of expected response when helpful
- If the response is JSON, put each field on a new line

## Formatting Rules

### Line length
- Keep lines under 130 characters
- All lines above 130 characters should be wrapped to the next line
- If a line is above 130 characters, it will have to be manually wrapped to the next line

### Parameter Documentation Format
```
- `parameter_name` (`type`): Description of what this parameter does.
```

### Automatically Injected Parameters
```
- `session_user` (`User`): The authenticated user (automatically injected by `@require_session`).
```

### Path Parameters
```
- `location` (`str`): The destination location for the mission upload (path parameter).
```

### Return Documentation Format
```
- `JsonResponse`:
  - **Success (200)**: `{'key': 'value', 'status': 200}`
  - **Error (404)**: HTTP 404 response with error message (not JSON)
```

**Important**: JSON endpoints return JSON only on success. Error responses are standard HTTP responses with appropriate status codes and error messages, not JSON objects.

### HTTP Example Format
```
POST /api/v1/endpoint/path
{
    "parameter": "value",
    "other_param": 123
}
```

## Common Patterns and Examples

### Authentication Parameters
```python
- `session_user` (`User`): The authenticated user (automatically injected by `@require_session`).
```

### Path Parameters
```python
- `server_name` (`str`): The name of the server to operate on (path parameter).
- `location` (`str`): The destination location for the upload (path parameter).
```

### Request Body Parameters
```python
- `bot_token` (`str`): The bot token for authentication.
- `role_name` (`str`): The name of the role to create.
- `**kwargs`: Role permissions as key-value pairs (e.g., `can_create_group=True`).
```

### Common Return Types

#### JsonResponse
```python
- `JsonResponse`: JSON response with content-type 'text/json'
  - **Success (200)**: `{'key': 'value'}` (JSON object)
  - **Error (400+)**: HTTP error response with status code and error message
```

#### WebResponse
```python
- `WebResponse`: Plain text response with content-type 'text/plain'
  - **Success (200)**: Plain text response body
  - **Error (400+)**: HTTP error response with status code and error message
```

#### Ok
```python
- `Ok`: HTTP 200 response (extends WebResponse)
  - **Success (200)**: Optional plain text data
```

#### Created
```python
- `Created`: HTTP 201 response (extends WebResponse)
  - **Success (201)**: Optional plain text data
```

#### Exists/DoesNotExist
```python
- `Exists`: HTTP 200 or 409 response based on existence check
  - **Exists (200)**: 'Exists' message
  - **Does not exist (409)**: 'Does not exist' message
```

#### HtmlResponse
```python
- `HtmlResponse`: HTML response with content-type 'text/html'
  - **Success (200)**: HTML content string
```

#### ServerSentEventResponse
```python
- `ServerSentEventResponse`: Server-sent events with content-type 'text/event-stream'
  - **Success (200)**: Continuous stream of WebEvent objects encoded as SSE format
  - **Error (401+)**: HTTP error response with status code and error message
```

### Authorization Requirements in Description
```
Requires an active session and the `can_create_group` role.
This endpoint is only available for local requests (internal server administration).
Requires an active session and `can_upload_mission` permission.
```

## Decorator-Specific Documentation

### @define_api / @define_async_api
Used for API functions that return WebResponse objects. These decorators handle BwServerError exceptions automatically:
```python
# No special parameter documentation needed - these are internal decorators
```

### @url_endpoint
Used for URL-based endpoints that return WebResponse objects:
```python
# No special parameter documentation needed - handles BwServerError exceptions automatically
```

### @json_endpoint
Automatically parses JSON request body and injects parameters. Handles JSON parsing errors:
```python
# Parameters from JSON request body are automatically injected - document them normally
# Do not document the JSON parsing behavior in individual endpoint docstrings
```

### @html_endpoint
Injects HTML template content and handles caching. Always document the injected `html` parameter:
```python
- `html` (`str`): The HTML template content (automatically injected by `@html_endpoint`).
```

### @sse_endpoint
Handles server-sent events streaming. The function should return AsyncGenerator[WebEvent | BaseEvent]:
```python
# Document the return type as ServerSentEventResponse
# The decorator handles conversion from AsyncGenerator to ServerSentEventResponse
```

### @require_session
Always document the injected `session_user` parameter:
```python
- `session_user` (`User`): The authenticated user (automatically injected by `@require_session`).
```

### @require_local
Mention local access restriction in description and error responses:
```python
This endpoint is only available for local requests (internal server administration).
```

### @require_user_role / @require_group_permission
Include the required role/permission in the description:
```python
Requires an active session and the `can_create_group` role.
Requires an active session and `can_upload_mission` permission.
```

## Quality Checklist

Before submitting endpoint docstrings, verify:
- [ ] Title uses `###` and describes the endpoint action
- [ ] AI attribution line `*Docstring generated by AI.*` is present after the title
- [ ] Description includes authentication/authorization requirements
- [ ] All non-injected parameters are documented
- [ ] Injected parameters note their decorator source
- [ ] Path parameters are clearly identified
- [ ] Return types include all possible status codes
- [ ] HTTP examples show correct method and URL
- [ ] Request body examples use valid JSON format
- [ ] Error responses are comprehensive and accurate
- [ ] Local-only endpoints are clearly marked
- [ ] Permission/role requirements are documented
- [ ] All lines are below 130 characters

## Notes
- Use triple quotes (`"""`) for all docstrings
- Maintain 4-space indentation for docstring content
- **Important**: JSON endpoints return JSON only on success - all error responses are standard HTTP responses with status codes and error messages, not JSON objects
- Be specific about HTTP status codes and their meanings
- Include all possible error scenarios from decorators
- Make HTTP examples copy-pasteable
- Use realistic parameter values in examples
- Document template injection for HTML endpoints
- Clearly distinguish between path parameters and request body parameters